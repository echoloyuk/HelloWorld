<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width; initial-scale=1.0; minimum-scale=1.0; maximum-scale=1.0; user-scalable=no;" />
<title>HelloWorld prototype</title>
<link rel="stylesheet" type="text/css" href="src/css/global.css">
<link rel="stylesheet" type="text/css" href="src/css/editor.css">
<link rel="stylesheet" type="text/css" href="src/css/content.css">
<script type="text/javascript" src="src/js/jquery.js"></script>
<script type="text/javascript" src="src/js/marked.js"></script>
<script type="text/javascript" src="src/js/jquery.form.js"></script>
<style type="text/css">
.example{
    position:absolute;
    border:1px solid red;
    top:0;left:0;right:0;bottom:0;
}
</style>
</head>

<body style="-moz-filter:blur(3px);">
    <div class="example">
        <div class="h-outer" id="helloWorld">
            <div class="h-textarea">
                <div class="h-title-panel">
                    <input type="text" id="hTitle" class="h-title" placeholder="在这里输入标题">
                </div>
                <div class="h-tool-panel">
                    <div class="h-tool-item h-tool-pic" title="图片">图片</div>
                    <div class="h-tool-item h-tool-pic" title="链接">链接</div>
                </div>
                <div class="h-content-panel">
                    <textarea class="h-content" id="hContent" placeholder="在这里输入正文"></textarea>
                </div>
            </div>
            <div class="h-preview" id="hPreview">
                <div class="h-text-content-title">无标题</div>
                <div class="h-text-content">
                </div>
            </div>
        </div>
        <div class="h-img-upload-dialog" id="upLoadDialog">
            <div class="h-file-header">
                <span>上传图片</span>
                <div class="h-file-header-close" id="closeImgDialog">×</div>
            </div>
            <div class="h-file-panel">
                <form id="imgUploadForm" enctype="multipart/form-data" method="post">
                    <input type="file" class="h-file-upload">
                </form>
            </div>
            <div class="h-file-info">
                <span>上传限制：10M，类型：png, jpg, gif</span>
            </div>
            <div class="h-file-percent h-file-percent-outer">
                <div class="h-file-percent-inner"></div>
            </div>
            <div class="h-file-upload-btn">
                <div class="upload-btn" id="imgUploadBtn">上传</div>
            </div>
        </div>
        <div class="h-mask" id="mask"></div>
    </div>
</body>
<script type="text/javascript">
$(function (){
    var inputDealer = function (){
        var $title = $('#hTitle'),
            $content = $('#hContent');
        var $pre = $('#hPreview');
        var str = '';

        $pre.html('');
        str += '<div class="h-text-content-title">' + ($title.val() || '无标题') + '</div>';
        str += '<div class="h-text-content">';
        str += marked($content.val());
        str += '</div>';

        $pre.html(str);
    };

    $('#hContent').on('input', function (){
        inputDealer();
    });
    $('#hTitle').on('input', function (){
        inputDealer();
    });

    //用于处理shift+tab键的组合件事件
    $('#hContent').on('keydown', function (e){
        var key = e.keyCode;
        if (key === 16){
            window.isShift = window.isShift || true;
        }
    }).on('keyup', function (e){
        var key = e.keyCode;
        if (key === 16){
            window.isShift = false;
        }
    });
    //处理缩进相关
    $('#hContent').on('keydown', function (e){
        var $c = $('#hContent');
        var c = $c.get(0);
        var content = $c.val();
        var keyCode = e.keyCode;

        if (keyCode === 9 && !window.isShift){ //按下tab键进行缩进
            e.preventDefault();

            var start = c.selectionStart;
            var end = c.selectionEnd;
            if (start !== end){

                //将所有的内容向后缩进
                var firstLineOfRange = content.lastIndexOf('\n', start);
                if (firstLineOfRange < 0){
                    firstLineOfRange = 0;
                } else {
                    firstLineOfRange += 1;
                }
                var rangeStr = content.substring(firstLineOfRange, end);
                rangeStr = rangeStr.replace(/\n/g, '\n    ');
                rangeStr = '    ' + rangeStr;
                var strArr = [];
                strArr.push(content.slice(0, firstLineOfRange));
                strArr.push(rangeStr);
                var newEnd = content.slice(end, content.length).length;
                strArr.push(content.slice(end, content.length));
                var finalStr = strArr.join('');
                $c.val(finalStr);
                c.selectionStart = firstLineOfRange;
                c.selectionEnd = $c.val().length - newEnd; //重新计算位置
                //---------------------
            } else {

                //单个字的缩进
                var strArr = [];
                strArr.push(content.substring(0, start));
                strArr.push('    ');
                strArr.push(content.substring(start, content.length));
                var finalStr = strArr.join('');
                $c.val(finalStr);
                c.selectionStart = start + 4;
                c.selectionEnd = start + 4;
            }
            inputDealer();
        } else if (keyCode === 9 && window.isShift){ //按下shift+tab键进行反缩进
            e.preventDefault();

            var start = c.selectionStart;
            var end = c.selectionEnd;

            if (start !== end){

                //将所有内容向前缩进
                var firstLineOfRange = content.lastIndexOf('\n', start);
                if (firstLineOfRange < 1){
                    firstLineOfRange = 0;
                }
                var rangeStr = content.substring(firstLineOfRange, end);
                rangeStr = rangeStr.replace(/\n    /g, '\n');
                rangeStr = rangeStr.replace(/^    /, ''); //去掉开头的空格
                var strArr = [];
                strArr.push(content.slice(0, firstLineOfRange));
                strArr.push(rangeStr);
                var newEnd = content.slice(end, content.length).length;
                strArr.push(content.slice(end, content.length));
                finalStr = strArr.join('');
                $c.val(finalStr);
                c.selectionStart = firstLineOfRange
                c.selectionEnd = $c.val().length - newEnd;
            }
            inputDealer();
        }
    });

    //处理图片等
    $('#hContent').on('keydown', function (e){
        var $c = $('#hContent');
        var c = $c.get(0);
        var content = $c.val();
        var keyCode = e.keyCode;
        var start = c.selectionStart;
        var end = c.selectionEnd;

        //弹出窗口
        var openImgUpload = function (start){
            var $outer = $('#helloWorld');
            var $mask = $('#mask');
            var $dialog = $('#upLoadDialog');
            var $close = $('#closeImgDialog', $dialog);
            $outer.addClass('h-masked');
            $mask.show();
            $dialog.show();
            $close.off('click').on('click', function (){
                closeImgUpload();
            });

        }

        //关闭窗口
        var closeImgUpload = function (start){
            var $outer = $('#helloWorld');
            var $mask = $('#mask');
            var $dialog = $('#upLoadDialog');
            var $close = $('#closeImgDialog', $dialog);
            $outer.removeClass('h-masked');
            $mask.hide();
            $dialog.hide();
        }

        if (start === end && keyCode === 219 && content[start - 1] === '!'){ //![时出现图片插入，图片的特征是![替代文字](链接)
            console.log('弹出上传图片的窗口');
            openImgUpload();
        }
    });


    inputDealer();
});
</script>
</html>
