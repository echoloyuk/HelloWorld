<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width; initial-scale=1.0; minimum-scale=1.0; maximum-scale=1.0; user-scalable=no;" />
<title>HelloWorld</title>
<link rel="stylesheet" type="text/css" href="src/css/global.css">
<link rel="stylesheet" type="text/css" href="src/css/editor.css">
<link rel="stylesheet" type="text/css" href="src/css/content.css">
<script type="text/javascript" src="src/js/jquery.js"></script>
<script type="text/javascript" src="src/js/markdown.js"></script>
<style type="text/css">
.example{
    position:absolute;
    border:1px solid red;
    top:0;left:0;right:0;bottom:0;
}
</style>
</head>

<body>
    <div class="example">
        <div class="h-outer">
            <div class="h-textarea">
                <div class="h-title-panel">
                    <input type="text" id="hTitle" class="h-title" placeholder="在这里输入标题">
                </div>
                <div class="h-tool-panel">
                    <div class="h-tool-item h-tool-pic" title="图片">图片</div>
                    <div class="h-tool-item h-tool-pic" title="链接">链接</div>
                </div>
                <div class="h-content-panel">
                    <textarea class="h-content" id="hContent" placeholder="在这里输入正文"></textarea>
                </div>
            </div>
            <div class="h-preview" id="hPreview">
                <div class="h-text-content-title">无标题</div>
                <div class="h-text-content">
                </div>
            </div>
        </div>
    </div>
</body>
<script type="text/javascript">
$(function (){
    var inputDealer = function (){
        var $title = $('#hTitle'),
            $content = $('#hContent');
        var $pre = $('#hPreview');
        var str = '';

        $pre.html('');
        str += '<div class="h-text-content-title">' + ($title.val() || '无标题') + '</div>';
        str += '<div class="h-text-content">';
        str += markdown.toHTML($content.val());
        str += '</div>';

        $pre.html(str);
    };

    $('#hContent').on('input', function (){
        inputDealer();
    });

    //按tab键屏蔽默认事件，未来加入自动空格
    $('#hContent').on('keydown', function (e){
        var key = e.keyCode;
        if (key === 9){
            e.preventDefault();
        }
    });

    $('#hContent').on('click', function (){
        var fun = function (){
            var $hContent = $('#hContent');
            var hContent = $hContent.get(0);
            var content = $hContent.val();
            if ('selectionStart' in hContent){
                var s = hContent.selectionStart; //选中的字符起始位置。
                var e = hContent.selectionEnd; //选中的字符串终止位置。
            } else {
                hContent.focus();
                var sel = document.selection.createRange();
                var range = document.selection.createRange().text.length; //选中了多少个字的数字
                var selStr = document.selection.createRange().text; //选中的文字
                sel.moveStart('character', -hContent.value.length); //将光标从当前选中的位置，向前选所有的文字
                var pos = sel.text.length - range; //选中结束的位置向前的字数 - 选中的字数 = 光标的起始位置。
                //上面代码有bug，向前选择可能会选择到其他非textarea的文字，所以导致文字位置计算错误

                console.log(sel.text + '!' + range);
                //console.log(content.substring(0, pos));
                //console.log(sel.boundingLeft);
            }
            
            
            //console.log(content.substring(s, e))
        };
        fun();
    });

    //处理缩进相关
    $('#hContent').on('keydown', function (e){
        var $c = $('#hContent');
        var c = $c.get(0);
        var content = $c.val();
        var keyCode = e.keyCode;
        if (keyCode === 9){
            e.preventDefault();

            var start = c.selectionStart;
            var end = c.selectionEnd;
            if (start !== end){
                var str = content.substring(start, end);
                //str = str.replace('\n', '\n    '));
                
            }
        }
    });
});
</script>
</html>
